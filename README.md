# Excel Data Processor

## Описание проекта

**Excel Data Processor** — инструмент для автоматизированной обработки ежемесячных Excel-файлов Росстата  
**«Производство основных видов продукции в натуральном выражении (годовые данные)»**  
по кодам **ОКПД2** (Общероссийский классификатор продукции по видам экономической деятельности).

Программа извлекает значения из таблиц, выполняет коррекцию данных между месяцами и сохраняет результаты в форматах **SQLite** и **CSV**, обеспечивая корректную совместимость с Microsoft Excel (десятичные запятые).

---

## Основные возможности

- Многопроцессорная обработка — параллельная обработка нескольких Excel-файлов  
- Автоматическая коррекция данных — исправление нулевых значений на основе данных следующего месяца  
- Экспорт в CSV — поддержка формата с десятичными запятыми  
- Валидация данных — контроль аномального роста значений между месяцами  
- Расширяемость — простое добавление новых кодов ОКПД через конфигурационный файл  

---

## Структура проекта

```text
project/
├── main.py              # Основной скрипт обработки
├── okpd.txt             # Справочник кодов ОКПД
├── data/                # Папка с исходными Excel-файлами
│   ├── 2024.01.01.xlsx
│   ├── 2024.02.01.xlsx
│   └── ...
├── data.db              # База данных SQLite (создается автоматически)
└── data.csv             # CSV-экспорт (создается автоматически)
```

---

## Зависимости

- pandas  
- openpyxl  

### Установка

```bash
pip install pandas openpyxl
```

---

## Настройка

### 1. Справочник ОКПД

Создайте файл `okpd.txt` в формате:

```text
Наименование показателя - Код ОКПД
```

Пример:

```text
Добыча нефти - 06.10.1
Добыча газа - 06.20.1
Производство электроэнергии - 35.11.1
```

---

### 2. Подготовка Excel-файлов

1. Поместите файлы в папку `data/`
2. Формат имени файла: `ГГГГ.ММ.ДД.xlsx`  
   Пример: `2024.01.01.xlsx`
3. Ожидаемая структура таблицы:

|                          | Код ОКПД2 (ОКЕИ, ОКАТО) | Отчетный месяц | Предыдущий месяц | Период с начала отчетного года |
|--------------------------|------------------------|----------------|------------------|--------------------------------|
| **A**                    | **Б**                  | **1**          | **2**            | **3**                          |
| Электроэнергия           | 35.11.10               |                |                  |                                |
| Гигаватт-час (млн кВт·ч) | 247                    |                |                  |                                |
| Российская Федерация<br>без учета новых субъектов<br>(с 01.01.2023) | 643004.АГ | 102166,613 | 89901,727 | 974407,756 |

---

### 3. Настройка параметров обработки

В коде доступны следующие константы:

```python
ROW_OFFSET = 2
MAIN_COL_OFFSET = 1
PATCH_COL_OFFSET = 2
```

---

### 4. Ручные исправления (PATCHES)

Для корректировки данных за отсутствующие или ошибочные месяцы используется словарь `PATCHES`:

```python
PATCHES = {
    datetime(2024, 7, 1): {
        "source_file": "2024.08.01.xlsx",
        "column_offset": PATCH_COL_OFFSET,
    },
}
```

---

## Использование

### Запуск

```bash
python main.py
```

### Этапы выполнения

1. Загрузка справочника ОКПД  
2. Инициализация базы данных SQLite  
3. Обработка Excel-файлов  
4. Коррекция данных между месяцами  
5. Применение ручных исправлений  
6. Валидация значений  
7. Экспорт в CSV  

---

## Результаты

### SQLite (`data.db`)

- Таблица `DATA`
- Колонка `DATE` + показатели из `okpd.txt`
- Тип значений: `FLOAT`

### CSV (`data.csv`)

- Разделитель: `;`
- Десятичный разделитель: `,`
- Кодировка: `utf-8-sig`

---

## Логика обработки

### Извлечение значений

Для каждого кода ОКПД извлекаются:

- `value_main` — основное значение (смещение на две ячейки вниз, от ячейки со значением кода ОКПД «ROW_OFFSET = 2» и одну в право MAIN_COL_OFFSET = 1)  
- `value_patch` — значение предыдущего месяца (смещение на две ячейки вниз «ROW_OFFSET = 2» и две в право PATCH_COL_OFFSET = 2)  

### Коррекция

Если:

- в предыдущем месяце `value_main == 0`
- в текущем месяце `value_patch > 0`

→ значение переносится в предыдущий месяц.

---

## Мониторинг

### Предупреждения

Скрипт сообщает о:

- пропущенных значениях
- аномальном росте (>100%)

---

## Расширение

### Новые коды ОКПД

1. Добавьте строки в `okpd.txt`
2. Запустите скрипт — БД расширится автоматически

### Новые файлы

1. Добавьте Excel-файлы в `data/`
2. Запустите скрипт

### Изменение структуры Excel

Отредактируйте:

- `ROW_OFFSET`
- `MAIN_COL_OFFSET`
- `PATCH_COL_OFFSET`

---

## Контакты

filipchuk.al.job@gmail.com

---

## Примечание

Перед первым запуском убедитесь, что все Excel-файлы имеют корректный формат и находятся в папке `data/`.
